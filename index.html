<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Study Screen Recording</title>
</head>
<body>
  <h1>Welcome to the Study</h1>
  <p>Instructions: Click "Start Recording" and select the <strong>Spent</strong> tab or screen to share. You can stop by clicking "Stop Recording" OR stop screen sharing in your browser.</p>
  
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn" disabled>Stop Recording</button>
  
  <p><a href="https://playspent.org/" target="_blank" id="gameLink">Open Spent in new tab</a></p>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const pid = urlParams.get('pid') || 'unknown';

    let mediaRecorder;
    let recordedChunks = [];

    document.getElementById('startBtn').onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        console.log("‚úÖ Screen sharing stream acquired");

        mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });
        recordedChunks = [];

        // When data becomes available
        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) {
            console.log("üì¶ Data chunk received");
            recordedChunks.push(e.data);
          }
        };

        // When recording stops (either by button or browser stop)
        mediaRecorder.onstop = () => {
          console.log("üõë MediaRecorder stopped");

          const blob = new Blob(recordedChunks, { type: "video/webm" });

          fetch('https://script.google.com/macros/s/AKfycbwpxNBVOBxrpysptqhIhgD4fMY1c8DX2B1FEViTkopXpk4oQn2dh_ww06V8wP8cgBWj2Q/exec', {
            method: 'POST',
            body: blob,
            headers: {
              'Content-Type': 'video/webm'
            }
          })
          .then(response => response.json())
          .then(data => {
            console.log('‚òÅÔ∏è Upload response:', data);
            if(data.status === 'success'){
              alert('‚úÖ Upload successful!');
              window.location.href = `https://www.butler.edu/?pid=${pid}`;
            } else {
              alert('‚ùå Upload failed: ' + data.message);
            }
          })
          .catch(err => {
            console.error('‚ùå Upload error:', err);
            alert('Upload error: ' + err);
          });
        };

        mediaRecorder.onerror = (event) => {
          console.error('‚ùå MediaRecorder error:', event.error);
        };

        // Auto-stop if user clicks ‚ÄúStop Sharing‚Äù in browser
        stream.getVideoTracks()[0].addEventListener('ended', () => {
          console.log("üì¥ Screen sharing manually stopped by participant");
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
          }
        });

        // Start recording
        mediaRecorder.start();
        console.log("‚ñ∂Ô∏è MediaRecorder started");
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        alert('Recording started. Now switch to Spent tab or screen.');
        
      } catch (err) {
        console.error('‚ùå Error accessing display media:', err);
        alert('Error accessing display media: ' + err);
      }
    };

    document.getElementById('stopBtn').onclick = () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        console.log("‚èπ Stop Recording button clicked");
        mediaRecorder.stop();
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
      }
    };
  </script>
</body>
</html>

