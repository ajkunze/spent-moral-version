<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Study Screen Recording</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    h1 { text-align: center; }
    ol { margin-top: 1em; }
    button { font-size: 1.1em; margin: 10px 5px; padding: 10px 20px; }
    a { color: blue; text-decoration: underline; }
  </style>
</head>
<body>
  <h1>Study Instructions</h1>
  <ol>
    <li><strong>Read all instructions carefully.</strong> Understand the task before you begin.</li>
    <li>Open the <a href="https://playspent.org/" target="_blank" rel="noopener noreferrer" id="gameLink">Spent Game</a> in a new tab.</li>
    <li>Click <strong>Start Recording</strong> below and select the <em>Spent</em> game tab or your full screen to share.</li>
    <li>Play the game according to the instructions on the game page.</li>
    <li>When done, either click <strong>Stop Recording</strong> button here, or manually stop screen sharing from your browser toolbar. The recording will then download automatically and you will be redirected to the post-survey page.</li>
  </ol>

  <div style="text-align:center; margin-top: 20px;">
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
  </div>

  <script>
    // Get participant ID from URL params, default to 'unknown' if missing
    const urlParams = new URLSearchParams(window.location.search);
    const pid = urlParams.get('pid') || 'unknown';

    // Set your redirect URL here
    const redirectURL = 'https://butler.edu' + encodeURIComponent(pid);

    let mediaRecorder;
    let recordedChunks = [];

    document.getElementById('startBtn').onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });

        // Detect manual stop of screen sharing
        stream.getVideoTracks()[0].addEventListener('ended', () => {
          if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            stopRecordingAndRedirect();
          }
        });

        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        recordedChunks = [];

        mediaRecorder.ondataavailable = event => {
          if (event.data.size > 0) recordedChunks.push(event.data);
        };

        mediaRecorder.start();
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;

        alert('Recording started. Switch to the Spent game tab or screen to play.');
      } catch (err) {
        alert('Error starting screen capture: ' + err);
      }
    };

    document.getElementById('stopBtn').onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        stopRecordingAndRedirect();
      }
    };

    function stopRecordingAndRedirect() {
      mediaRecorder.stop();
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;

      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);

        // Use pid in the file name
        const fileName = `spent_recording_${pid}_${Date.now()}.webm`;

        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();

        // Redirect after a short delay to ensure download starts
        setTimeout(() => {
          window.location.href = redirectURL;
        }, 1000);
      };
    }
  </script>
</body>
</html>

