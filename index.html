<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Study Screen Recording</title>
</head>
<body>
  <h1>Welcome to the Study</h1>
  <p>Instructions: Click "Start Recording" and select the <strong>Spent</strong> tab or screen to share.</p>
  
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn" disabled>Stop Recording</button>
  
  <p><a href="https://playspent.org/" target="_blank" id="gameLink">Open Spent in new tab</a></p>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const pid = urlParams.get('pid') || 'unknown';

    let mediaRecorder;
    let recordedChunks = [];

    document.getElementById('startBtn').onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });
        recordedChunks = [];

        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.start();
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        alert('Recording started. Now switch to Spent tab or screen.');
      } catch (err) {
        alert('Error accessing display media: ' + err);
      }
    };

    document.getElementById('stopBtn').onclick = () => {
      mediaRecorder.stop();
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    };

    mediaRecorder?.addEventListener('stop', () => {
      const blob = new Blob(recordedChunks, { type: "video/webm" });

      // Upload to Google Apps Script Web App
      fetch('https://script.google.com/macros/s/AKfycbwpxNBVOBxrpysptqhIhgD4fMY1c8DX2B1FEViTkopXpk4oQn2dh_ww06V8wP8cgBWj2Q/exec', {
        method: 'POST',
        body: blob,
        headers: {
          'Content-Type': 'video/webm'
        }
      })
      .then(response => response.json())
      .then(data => {
        if(data.status === 'success'){
          alert('Upload successful!');
          // Redirect to Qualtrics post-survey here
          window.location.href = `https://www.butler.edu/`;
        } else {
          alert('Upload failed: ' + data.message);
        }
      })
      .catch(err => alert('Upload error: ' + err));
    });
  </script>
</body>
</html>

